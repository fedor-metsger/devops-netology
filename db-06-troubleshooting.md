# Домашнее задание к занятию 6. «Troubleshooting»

1. **Напишите список операций, которые вы будете производить для остановки запроса пользователя.**

  - Предварительно командой `db.setProfilingLevel()` должно быть включено профилирование:
  ```
  db.setProfilingLevel(1, { slowms: 50 })
  ```
  - при возникновении проблемы подключиться в shell MongoDB
  - запустить команду `db.currentOp()`, которая показывает текущие операции с 
  ```
  db.currentOp({“secs_running”: {$gte: 60}}) 
  ```
   - найти интересующую длительную операцию
   - запустить команду `db.killOp()` на остановку этой операции
  ```
  db.killOp(<opid>)
  ```

   **Предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB.**
   
   Для решения проблемы с долгими транзакциями нужно:
   - как в предыдущем пункте включить профилирование
   - выбирать долго текущие операции
   - с помощью команды `explain(‘executionStats’)` получить планы запросов для долготекущих операций
   - провести оптимизацию обработки запросов с помощью построения дополнительных индексов

---------------------

2. **Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL.**
   **Причём отношение количества записанных key-value-значений к количеству истёкших значений есть величина постоянная**
   **и увеличивается пропорционально количеству реплик сервиса.**

   **При масштабировании сервиса до N реплик вы увидели, что:**
   - сначала происходит рост отношения записанных значений к истекшим
   - Redis блокирует операции записи.
   **Как вы думаете, в чём может быть проблема?**
        
   Ответ: Истекшие пары **key-value** это те, которые могут быть удалены из базы данных.
   Если отношение в их пользу уменьшается, значит они удаляются, а место заполняется текущими
   значениями, то есть БД заполняется. Потом происходит блокировка записи, возможно
   запись вести уже некуда, то есть свободное место закончилось.
   
-----------------------------

3. **Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей в таблицах базы пользователи начали жаловаться на ошибки вида:**
    ```
    InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
    ```
   **Как вы думаете, почему это начало происходить и как локализовать проблему?**
   
   Обычно это указывает на проблемы с подключением к сети, в таком случае стоит проверить состояние сети.  
   Вышеупомянутая ошибка так же может возникать, когда запускается долгий запрос MySQL, который выполняется более нескольких секунд.

   
   **Какие пути решения этой проблемы вы можете предложить?**
   
   Чтобы исправить ошибку, может потребоваться изменить глобальные настройки, связанные с тайм-аутом, на сервере БД MySQL.
   Это можно сделать например настройкой `net_read_timeout`:
   ```
   SET GLOBAL net_read_timeout = 600;
   ```
   Или настройкой в конфигурационном файле:
   ```
   [mysqld]
   net_read_timeout = 600
   ```
   В случае, если ошибка возникает из-за долгих запросов, нужно сначала обраться к изучению возможность оптимизации этих запросов.
------------------------
4. **Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации,**
   **что эта СУБД работает с большим объёмом данных лучше, чем MySQL.**

   **После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:**

   `postmaster invoked oom-killer`

   **Как вы думаете, что происходит?**
   
   В ядре линукс есть механизм, который включается при недостатке оперативной памяти. Этот механизм по некоему алгоритму
   выбирает некоторые процессы и завершает их для осбождения ОЗУ. Значит этот механизм остановил процесс **postmaster**,
   по видимому, этот процесс потреблял слишком много ОЗУ. Процесс **postmaster** является центральным процессом **PostgreSQL**,
   значит, потребление **PostgreSQL** слишком велико. 

   **Как бы вы решили эту проблему?**
   
   Я бы изменил настройки СУБД **PostgreSQL**, а так же, возможно, ограничил количество одновременных сессий.
   Кроме того, изучил бы возможности оптимизации организации и обработки данных, например, партиционированием таблиц,
   или разбиением запров на более мелкие.
